<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta name="csrf-token" th:content="${_csrf.token}"/>
  <meta name="csrf-header" th:content="${_csrf.headerName}"/>
  <meta charset="UTF-8">
  <title>게시글 수정 - Summernote 에디터</title>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- Summernote CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
  <!-- Bootstrap JavaScript -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-4">
  <h2>게시글 수정</h2>
  <form id="postForm" enctype="multipart/form-data">
    <input data-th-name="${_csrf.parameterName}" data-th-value="${_csrf.token}" type="hidden" />
    <input type="hidden" id="boardNo" name="no" th:value="${board.no}" />
    <input type="hidden" id="existingBoardType" th:value="${board.boardType}" />

    <!-- 게시글 종류 표시 (수정 불가) -->
    <div class="form-group">
      <label for="boardType">게시글 종류</label>
      <input type="text" class="form-control" id="boardType" name="boardType"
             th:value="${board.boardType == 'trade' ? '거래 게시글' : '일반 게시글'}" readonly>
    </div>

    <!-- 공통 필드 -->
    <div class="form-group">
      <label for="title">제목</label>
      <input type="text" class="form-control" id="title" name="title" required th:value="${board.title}">
    </div>

    <div class="form-group">
      <label for="content">내용</label>
      <textarea id="content" name="content" class="form-control" th:utext="${board.content}"></textarea>
    </div>

    <!-- 거래 게시글 전용 필드 -->
    <div id="tradeFields" th:style="${board.boardType == 'trade' ? 'display: block;' : 'display: none;'}">
      <div class="form-group">
        <label for="price">가격</label>
        <input type="number" class="form-control" id="price" name="price" th:value="${board.price}">
      </div>

      <div class="form-group">
        <label for="tradeType">거래 방식</label>
        <select id="tradeType" name="tradeType" class="form-control">
          <option value="sell" th:selected="${board.tradeType == 'sell'}">판매</option>
          <option value="buy" th:selected="${board.tradeType == 'buy'}">구매</option>
        </select>
      </div>

      <div class="form-group">
        <label for="collectionNo">수집품 선택</label>
        <select id="collectionNo" name="collection.no" class="form-control">
          <option value="" disabled>수집품을 선택하세요</option>
          <option th:each="collection : ${collections}"
                  th:value="${collection.no}"
                  th:selected="${board.collection != null && board.collection.no == collection.no}"
                  th:data-filename="${collection.filename}"
                  th:text="${collection.name}">
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>수집품 이미지</label>
        <img id="collectionImage" th:if="${board.collection != null}"
             th:src="@{'https://kr.object.ncloudstorage.com/bitcamp-moum/board/' + ${board.collection.filename}}"
             alt="수집품 이미지" style="width: 50%; float: left;" class="note-float-left">
      </div>
    </div>

    <!-- 수정 버튼 -->
    <div class="form-group mt-3">
      <button type="button" class="btn btn-primary" onclick="updatePost()">수정하기</button>
      <a href="javascript:history.back()" class="btn btn-secondary">취소</a>
    </div>
  </form>
</div>

<script th:inline="javascript">
  // Summernote 에디터 초기화
  $(document).ready(function() {
    $('#content').summernote({
      placeholder: '내용을 입력하세요 (최대 2048자)',
      height: 300,
      toolbar: [
        ['style', ['style']],
        ['font', ['bold', 'italic', 'underline', 'strikethrough']],
        ['fontsize', ['fontsize']],
        ['color', ['color']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['table', ['table']],
        ['insert', ['link', 'picture']],
        ['view', ['fullscreen', 'codeview', 'help']]
      ],
    });

    // 기존 이미지가 있는 경우 로드
    var existingCollection = /*[[${board.collection}]]*/ null;
    if (existingCollection && existingCollection.filename) {
      var imageUrl = 'https://kr.object.ncloudstorage.com/bitcamp-moum/board/' + existingCollection.filename;
      $('#collectionImage').attr('src', imageUrl);
    }
  });

  // 수집품 이미지 변경 이벤트
  document.getElementById('collectionNo').addEventListener('change', function() {
    var selectedOption = this.options[this.selectedIndex];
    var filename = selectedOption.getAttribute('data-filename');
    if (filename) {
      var imageUrl = 'https://kr.object.ncloudstorage.com/bitcamp-moum/board/' + filename;
      document.getElementById('collectionImage').src = imageUrl;
    }
  });

  // 게시글 수정 함수
  function updatePost() {
    var formData = new FormData($('#postForm')[0]);
    var boardNo = $('#boardNo').val();

    if (formData.get("price") === "") {
      formData.set("price", 0);
    }

    $.ajax({
      url: '/board/update/' + boardNo,
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      beforeSend: function(xhr) {
        var token = $("meta[name='csrf-token']").attr("content");
        var header = $("meta[name='csrf-header']").attr("content");
        xhr.setRequestHeader(header, token);
      },
      success: function(response) {
        alert('게시글이 수정되었습니다.');
        window.location.href = '/board/boardView/' + boardNo;
      },
      error: function(xhr, status, error) {
        alert('게시글 수정에 실패했습니다: ' + error);
      }
    });
  }
</script>
</body>
</html>