<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>회원 수정</title>
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link data-th-href="@{/css/info.css}" rel="stylesheet">
	<link data-th-href="@{/css/style.css}" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
<div th:replace="~{header :: header}"></div>
<main>

	<div class="wrapper">
		<!-- 검증 -->
		<div class="alert alert-success" th:if="${message}" th:text="${message}"></div>
		<div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>

		<div th:unless="${user}">
			<p>사용자 정보를 찾을 수 없습니다.</p>
		</div>

		<div class="my-info-container" data-th-if="${user}" data-th-object="${user}">
			<form class="profile-form"
			      enctype="multipart/form-data"
			      method="post"
			      onsubmit="return validateForm()"
			      th:action="@{/user/update}">

				<!-- 프로필 이미지 -->
				<div class="profile-img-container">
					<div class="profile-img-inner-container">
						<img alt="프로필 이미지"
						     class="profile-img"
						     id="previewImage"
						     th:src="${user.photo != null} ?
                         'https://qc02pnrw5255.edge.naverncp.com/JjKIB1bIlV/user/profile/' + ${user.photo} + '?type=f&w=400&h=400' :
                         'https://qc02pnrw5255.edge.naverncp.com/JjKIB1bIlV/images/default-profile.png?type=f&w=400&h=400'">
						<input accept="image/*"
						       id="file"
						       name="file"
						       onchange="validateAndPreviewImage(this)"
						       type="file">
						<div class="error-message" id="errorMessage" style="color: red; display: none;"></div>
					</div>
					<!-- 버튼 그룹 -->
					<div class="btn-group w-100" role="group">
						<button class="btn btn-dark" type="submit">변경하기</button>
						<button class="btn btn-secondary" onclick="window.location.href='/user/myInfo'"
						        type="button">취소</button>
					</div>
				</div>

				<!-- 사용자 정보 -->
				<div class="my-info-right-container">
					<input name="no" th:value="*{no}" type="hidden">

					<div class="my-info-right-container-header">
						<!-- 업적 업데이트 !-->
						<div class="my-primary-achievement">
							<div class="input-achievement">
								<!-- btn-group을 사용하여 드롭다운 버튼 형식으로 바꾸기 -->
								<div class="btn-group w-100">
									<!-- 버튼: 사용자가 선택한 업적이 여기 표시됨 -->
									<button aria-expanded="false"
									        class="btn btn-outline-secondary dropdown-toggle w-100"
									        data-bs-toggle="dropdown" type="button">
										<span id="achievement-selected">업적을 선택하세요</span> <!-- 기본 텍스트 -->
									</button>
									<ul class="dropdown-menu w-100">
										<!-- 업적 리스트 동적 출력 -->
										<th:block th:if="${not #lists.isEmpty(listGetUserAchievement)}">
											<th:block th:each="title : ${listGetUserAchievement}">
												<li>
													<a class="dropdown-item" href="#"
													   onclick="selectAchievement(this)" th:data-id="${title.id}"
													   th:text="${title.name}">
														<!-- 업적 이름 표시 -->
													</a>
												</li>
												<th:block th:if="${title.isPrimary == 1}">
													<script th:inline="javascript">
														window.addEventListener('load', function() {
															const id = /*[[${title.id}]]*/ '[[${title.id}]]';
															// 동적으로 click 이벤트 트리거 (this가 해당 요소로 동작)
															document.querySelector(`[data-id='${id}']`).click();
														});
													</script>
												</th:block>
											</th:block>
										</th:block>

										<!-- 업적이 없는 경우 처리 -->
										<th:block th:if="${#lists.isEmpty(listGetUserAchievement)}">
											<li><a class="dropdown-item" href="#">업적이 없습니다</a></li>
										</th:block>
									</ul>
								</div>
								<!-- 선택된 업적 ID를 저장할 hidden input -->
								<input data-th-value="${userAchievementId}" id="user-achievement" name="user-achievement"
								       type="hidden">
							</div>
						</div>

						<!-- 닉네임 표시 및 수정 필드 -->
						<div class="user-nickname">
							<div class="input-field">
								<div id="nicknameDisplay" style="display: flex; align-items: center;">
									<span th:text="*{nickname}"></span>
									<button class="btn" onclick="showNicknameEdit()" type="button">수정</button>
								</div>

								<div id="nicknameEdit" style="display: none;">
									<div style="display: flex; align-items: center;">
										<input id="nickname" name="nickname" th:value="*{nickname}" type="text"/>
										<button class="btn"
										        onclick="checkDuplicate('nickname', document.getElementById('nickname').value)"
										        type="button">중복확인
										</button>
										<button class="btn" onclick="hideNicknameEdit()" type="button">취소</button>
									</div>
								</div>
								<span id="nicknameMessage"></span>
							</div>
						</div>
					</div>

					<div class="my-info-right-container-body">
						<div class="my-board-container">
							<h4 class="text-center" style="margin-bottom: 2rem;">회원 수정</h4>
							<div class="input-field">
								<label for="email">이메일</label>
								<input id="email"
								       name="email"
								       readonly
								       th:value="*{email}"
								       type="text">
							</div>

							<div class="input-field">
								<label for="password">비밀번호</label>
								<input id="password"
								       minlength="8"
								       name="password"
								       oninput="toggleConfirmPasswordField()"
								       pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$"
								       placeholder="변경하지 않으면 기존 비밀번호 유지"
								       title="최소 8자, 영문, 숫자, 특수문자를 포함해야 합니다"
								       type="password">
								<span id="passwordMessage"></span>
							</div>

							<div class="input-field" id="confirmPasswordField" style="display: none;">
								<label for="confirmPassword">비밀번호 확인</label>
								<input id="confirmPassword"
								       placeholder="비밀번호 확인"
								       type="password">
								<span id="confirmPasswordMessage"></span>
							</div>
							<form id="withdrawForm" method="post" onsubmit="return confirmWithdraw()"
							      th:action="@{/user/delete}">
								<input name="no" th:value="${user.no}" type="hidden">
								<button class="btn btn-danger" type="submit">
									회원탈퇴
								</button>
							</form>
						</div>

					<div class="my-achievement-container">
						<!-- SNS 연동 섹션 -->
						<div class="input-field sns-connection-section">
							<div class="sns-connection-title">
								<h4 class="text-center" style="margin-bottom: 2rem;">SNS 계정 연동</h4>
							</div>

							<!-- Google 연동 -->
							<div class="sns-connection-item">
								<button class="btn btn-light w-100 py-2 border"
								        disabled
								        style="background-color: #f2f2f2; color: gray;"
								        th:if="${connectedProviders != null && connectedProviders.contains('google')}">
									<img alt="Google Icon" class="me-2" src="/images/user/Google.png"
									     style="width: 20px; height: 20px;">
									Google 연동완료
								</button>
								<a class="btn btn-light w-100 py-2 border"
								   href="/oauth2/authorization/google"
								   style="background-color: #f2f2f2;"
								   th:unless="${connectedProviders != null && connectedProviders.contains('google')}">
									<img alt="Google Icon" class="me-2" src="/images/user/Google.png"
									     style="width: 20px; height: 20px;">
									Google 연동하기
								</a>
							</div>

							<!-- Naver 연동 -->
							<div class="sns-connection-item">
								<button class="btn w-100 py-2 text-white"
								        disabled
								        style="background-color: #03c75a; color: gray;"
								        th:if="${connectedProviders != null && connectedProviders.contains('naver')}">
									<img alt="Naver Icon" class="me-2" src="/images/user/Naver.png"
									     style="width: 20px; height: 20px;">
									Naver 연동완료
								</button>
								<a class="btn w-100 py-2 text-white"
								   href="/oauth2/authorization/naver"
								   style="background-color: #03c75a;"
								   th:unless="${connectedProviders != null && connectedProviders.contains('naver')}">
									<img alt="Naver Icon" class="me-2" src="/images/user/Naver.png"
									     style="width: 20px; height: 20px;">
									Naver 연동하기
								</a>
							</div>

							<!-- Kakao 연동 -->
							<div class="sns-connection-item">
								<button class="btn w-100 py-2"
								        disabled
								        style="background-color: #FEE500; color: gray;"
								        th:if="${connectedProviders != null && connectedProviders.contains('kakao')}">
									<img alt="Kakao Icon" class="me-2" src="/images/user/KakaoTalk.png"
									     style="width: 20px; height: 20px;">
									Kakao 연동완료
								</button>
								<a class="btn w-100 py-2"
								   href="/oauth2/authorization/kakao"
								   style="background-color: #FEE500;"
								   th:unless="${connectedProviders != null && connectedProviders.contains('kakao')}">
									<img alt="Kakao Icon" class="me-2" src="/images/user/KakaoTalk.png"
									     style="width: 20px; height: 20px;">
									Kakao 연동하기
								</a>
							</div>
						</div>
					</div>
				</div>
				</div>
			</form>
		</div>
	</div>
</main>
<script th:src="@{/js/user.js}"></script>
<script th:src="@{/js/achievement.js}"></script>
<div th:replace="~{footer :: footer}"></div>
</body>
</html>
