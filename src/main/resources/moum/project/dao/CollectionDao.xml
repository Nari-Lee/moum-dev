<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="moum.project.dao.CollectionDao">

  <resultMap id="CollectionMap" type="moum.project.vo.Collection">
    <id column="collection_id" property="no"/>
    <result column="user_id" property="userNo"/>
    <result column="maincategory_id" property="maincategoryNo"/>
    <result column="subcategory_id" property="subcategoryNo"/>
    <result column="name" property="name"/>
    <result column="en_name" property="enName"/>
    <result column="status_id" property="statusNo"/>
    <result column="purchase_date" property="purchaseDate"/>
    <result column="purchase_place" property="purchasePlace"/>
    <result column="price" property="price"/>
    <result column="storage_location" property="storageLocation"/>
    <result column="post_date" property="postDate"/>

    <collection property="attachedFiles" ofType="moum.project.vo.AttachedFile">
      <id column="photo_id" property="no"/>
      <result column="filename" property="filename"/>
      <result column="origin_filename" property="originFilename"/>
    </collection>
  </resultMap>

  <resultMap id="AttachedFileMap" type="moum.project.vo.AttachedFile">
    <id column="photo_id" property="no"/>
    <result column="filename" property="filename"/>
    <result column="origin_filename" property="originFilename"/>
  </resultMap>

  <insert id="insert" parameterType="moum.project.vo.Collection"
          useGeneratedKeys="true" keyColumn="collection_id" keyProperty="no">
    insert into collection(user_id, subcategory_id, name, en_name, status_id,
      purchase_date, purchase_place, price, storage_location)
    values(#{userNo}, #{subcategoryNo}, #{name}, #{enName}, #{statusNo},
      #{purchaseDate}, #{purchasePlace}, #{price}, #{storageLocation})
  </insert>

  <select id="list" resultMap="CollectionMap">
    select
      c.collection_id,
      c.name,
      sc.maincategory_id,
      c.subcategory_id,
      c.status_id,
      cs.status_name,
      cp.photo_id,
      cp.filename,
      cp.origin_filename
    from
      collection c
      left join collection_status cs on c.status_id = cs.status_id
      left join collection_photo cp on c.collection_id = cp.collection_id
      left join subcategory sc on c.subcategory_id = sc.subcategory_id
    where
      c.user_id = 2
  </select>

  <select id="findBy" resultMap="CollectionMap" parameterType="int">
    select
      c.collection_id,
      c.name,
      c.en_name,
      c.price,
      sc.maincategory_id,
      c.subcategory_id,
      c.purchase_date,
      c.purchase_place,
      c.storage_location,
      c.status_id,
      cs.status_name,
      cp.photo_id,
      cp.filename,
      cp.origin_filename
    from
      collection c
      left join collection_status cs on c.status_id = cs.status_id
      left join subcategory sc on c.subcategory_id = sc.subcategory_id
      left outer join collection_photo cp on c.collection_id = cp.collection_id
    where
      c.collection_id = #{no}
  </select>

  <update id="update">
    update
      collection
    set
      name = #{name},
      en_name = #{enName},
      subcategory_id = #{subcategoryNo},
      status_id = #{statusNo},
      purchase_date = #{purchaseDate},
      purchase_place = #{purchasePlace},
      price = #{price},
      storage_location = #{storageLocation}
    where
      collection_id = #{no}
  </update>

  <delete id="delete" parameterType="int">
    delete from collection
    where collection_id = #{no}
  </delete>

  <insert id="insertFiles" parameterType="moum.project.vo.Collection">
    insert into collection_photo(collection_id, filename, origin_filename)
    values
    <foreach collection="attachedFiles" item="attachedFile" separator=",">
      (#{no}, #{attachedFile.filename}, #{attachedFile.originFilename})
    </foreach>
  </insert>

  <delete id="deleteFiles" parameterType="int">
    delete from collection_photo
    where collection_id = #{no}
  </delete>

</mapper>
